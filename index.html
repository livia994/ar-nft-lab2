<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Room Light Surprise ‚Äì AR NFT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

  <!-- AR.js NFT (working version) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; }

    #title {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 10px 16px;
      font-size: 18px;
      border-radius: 8px;
      z-index: 10;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>

  <!-- Interaction + Story Components -->
  <script>
    // Toggle light component
    AFRAME.registerComponent('toggle-light', {
      init: function () {
        const el = this.el;
        this.isOn = false;
        el.classList.add('clickable');

        el.addEventListener('click', () => {
          this.isOn = !this.isOn;

          if (this.isOn) {
            el.setAttribute('material', { emissive: '#ffffaa', emissiveIntensity: 1 });
            el.sceneEl.emit('light-on');
          } else {
            el.setAttribute('material', { emissive: '#000000', emissiveIntensity: 0 });
            el.sceneEl.emit('light-off');
          }
        });
      }
    });

    // Cat interaction
    AFRAME.registerComponent('cat-interaction', {
      init: function () {
        const el = this.el;
        el.classList.add('clickable');

        el.addEventListener('click', () => {
          el.emit('jump');
          el.sceneEl.emit('cat-tapped');
        });
      }
    });

    // Story Manager
    AFRAME.registerComponent('story-manager', {
      init: function () {
        const scene = this.el;
        this.phase = 0; // 0 = dark, 1 = light on, 2 = cat appears, 3 = interaction

        this.text = document.querySelector('#storyText');
        this.cat = document.querySelector('#cat');

        // Initial story
        this.text.setAttribute('value', "Tap the bulb to turn on the room's light.");

        // Light ON
        scene.addEventListener('light-on', () => {
          if (this.phase === 0) {
            this.phase = 1;
            this.text.setAttribute('value', "Nice! The room is lit.\nLook‚Ä¶ someone appeared!");
            this.cat.setAttribute('visible', true);
            this.cat.emit('spawn');
          }
        });

        // Light OFF
        scene.addEventListener('light-off', () => {
          this.text.setAttribute('value', "It's dark again‚Ä¶ tap the bulb!");
          this.cat.setAttribute('visible', false);
        });

        // Cat clicked
        scene.addEventListener('cat-tapped', () => {
          this.text.setAttribute('value', "The cat likes you! Tap again!");
        });
      }
    });
  </script>

</head>

<body>

  <div id="title">üê± Room Light Surprise üê±</div>

  <a-scene
    embedded
    renderer="logarithmicDepthBuffer: true"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false"
    story-manager>

    <!-- Camera -->
    <a-entity camera>
      <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-entity>

    <!-- NFT Marker -->
    <a-nft 
      type="nft"
      url="pat"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.01"
      smoothThreshold="5">

      <!-- Story text -->
      <a-text
        id="storyText"
        value="Loading‚Ä¶"
        color="yellow"
        align="center"
        width="3"
        position="0 1.4 0">
      </a-text>

      <!-- Light bulb -->
      <a-entity
        id="bulb"
        gltf-model="scene.gltf"
        scale="0.35 0.35 0.35"
        position="0 0 0"
        toggle-light>
      </a-entity>

      <!-- Cat (initially hidden) -->
      <a-entity
        id="cat"
        gltf-model="cat.gltf"
        scale="0.25 0.25 0.25"
        position="0 -0.2 0"
        rotation="0 180 0"
        visible="false"
        cat-interaction
        animation__spawn="property: scale; from: 0 0 0; to: 0.25 0.25 0.25; dur: 600; easing: easeOutElastic"
        animation__jump="property: position; from: 0 -0.2 0; to: 0 0.1 0; dir: alternate; dur: 300; startEvents: jump">
      </a-entity>

    </a-nft>

  </a-scene>

</body>
</html>
