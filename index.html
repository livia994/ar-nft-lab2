<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blooming Worlds – AR NFT Project</title>

    <!-- AFRAME -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <!-- AR.js NFT -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar-nft.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: system-ui, sans-serif;
      }

      #ui {
        position: fixed;
        top: 10px;
        left: 10px;
        max-width: 320px;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.6);
        color: #ffffff;
        border-radius: 12px;
        z-index: 10;
      }

      #ui h1 {
        margin: 0 0 4px;
        font-size: 18px;
        font-weight: 600;
      }

      #ui p {
        margin: 3px 0;
        font-size: 13px;
      }

      #ui small {
        font-size: 11px;
        opacity: 0.9;
      }
    </style>
  </head>

  <body>
    <div id="ui">
      <h1>Blooming Worlds</h1>
      <p>The deep-sea light creature emerges from the painting.</p>
      <p id="story">Step 1 — A glowing seed ignites. Tap to evolve.</p>
      <small>Move around the marker to explore the creature.</small>
    </div>

    <a-scene
      embedded
      renderer="logarithmicDepthBuffer: true;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >

      <a-nft
        type="nft"
        url="flo"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.01"
        smoothThreshold="5"
        emitevents="true"
        id="marker"
      >

        <!-- STEP 1 — HUGE SEED -->
        <a-entity id="obj1" position="0 4.2 0" scale="6 6 6" visible="true">
          <a-sphere
            radius="1.5"
            color="#66FFFF"
            material="emissive: #33FFFF; emissiveIntensity: 1.1;"
            animation="property: scale; dir: alternate; dur: 1500; loop: true; to: 1.8 1.8 1.8; from: 1 1 1"
          ></a-sphere>

          <a-ring
            radius-inner="1.7"
            radius-outer="2.6"
            position="0 0 0.3"
            color="#99FFEE"
            material="emissive: #99FFEE; emissiveIntensity: 0.9; opacity: 0.7;"
            animation="property: rotation; to: 0 0 360; loop: true; dur: 2200"
          ></a-ring>
        </a-entity>

        <!-- STEP 2 — HUGE JELLYFISH -->
        <a-entity id="obj2" position="0 4.3 0" scale="6 6 6" visible="false">
          <!-- bell -->
          <a-sphere
            radius="2"
            position="0 0.8 0"
            color="#2244FF"
            material="opacity: 0.8; emissive: #7744FF; emissiveIntensity: 1.1;"
            animation="property: scale; dir: alternate; dur: 1600; loop: true; to: 1.3 1.15 1.3; from: 1 1 1"
          ></a-sphere>

          <!-- glowing core -->
          <a-sphere
            radius="0.9"
            position="0 0.8 0"
            color="#88FFFF"
            material="emissive: #AAFFEE; emissiveIntensity: 1.3;"
            animation="property: color; from: #88FFFF; to: #FF88FF; loop: true; dur: 1400"
          ></a-sphere>

          <!-- tentacles -->
          <a-cylinder
            radius="0.1"
            height="4"
            position="0.6 -1.6 0"
            color="#66FFFF"
            material="opacity: 0.9; emissive: #55FFFF; emissiveIntensity: 1;"
            animation="property: rotation; dir: alternate; dur: 1300; loop: true; to: 0 30 20; from: 0 -30 -20"
          ></a-cylinder>

          <a-cylinder
            radius="0.1"
            height="4.5"
            position="-0.55 -1.8 0.3"
            color="#66CCFF"
            material="opacity: 0.9; emissive: #55CCFF; emissiveIntensity: 1;"
            animation="property: rotation; dir: alternate; dur: 1500; loop: true; to: 0 -25 15; from: 0 25 -15"
          ></a-cylinder>

          <a-cylinder
            radius="0.1"
            height="4.2"
            position="0.1 -2.0 -0.3"
            color="#AA88FF"
            material="opacity: 0.9; emissive: #BB77FF; emissiveIntensity: 1;"
            animation="property: rotation; dir: alternate; dur: 1700; loop: true; to: 20 20 -20; from: -20 -20 20"
          ></a-cylinder>
        </a-entity>

        <!-- STEP 3 — HUGE PORTAL -->
        <a-entity id="panel" position="0 4.3 0" scale="6 6 6" visible="false">

          <!-- Outer rotating ring -->
          <a-ring
            radius-inner="2.5"
            radius-outer="3.8"
            color="#00FFFF"
            material="emissive: #00FFFF; emissiveIntensity: 1.2; opacity: 0.85;"
            animation="property: rotation; to: 0 0 360; loop: true; dur: 4000"
          ></a-ring>

          <!-- Pulsing aura -->
          <a-torus
            radius="3.2"
            radius-tubular="0.18"
            color="#44FFFF"
            material="emissive: #33DDFF; emissiveIntensity: 1.4; opacity: 0.6;"
            animation="property: scale; dir: alternate; loop: true; dur: 1800; to: 1.2 1.2 1.2; from: 1 1 1"
          ></a-torus>

          <!-- Inner swirling energy -->
          <a-circle
            radius="2.2"
            rotation="90 0 0"
            color="#0099FF"
            material="emissive: #66CCFF; emissiveIntensity: 1.3; opacity: 0.85;"
            animation="property: rotation; to: 0 0 360; dur: 2500; loop: true"
          ></a-circle>

          <!-- Subtle color pulse to make portal alive -->
          <a-circle
            radius="1.7"
            rotation="90 0 0"
            color="#AAFFFF"
            material="emissive: #88FFFF; emissiveIntensity: 1.4; opacity: 0.7;"
            animation="property: color; from: #AAFFFF; to: #FF99FF; loop: true; dur: 1800"
          ></a-circle>

          <!-- Floating glowing particles -->
          <a-entity id="particles">
            <a-sphere radius="0.1" color="#FFFFFF"
              material="emissive:#FFFFFF; emissiveIntensity:1.2; opacity:0.9;"
              position="1.2 0.8 0"
              animation="property: position; to:-1.2 1.2 0; loop:true; dur: 3000; dir:alternate">
            </a-sphere>

            <a-sphere radius="0.08" color="#88FFFF"
              material="emissive:#88FFFF; emissiveIntensity:1.4; opacity:0.8;"
              position="-0.8 -0.2 0.3"
              animation="property: position; to:0.8 -1.1 0.3; loop:true; dur: 2600; dir:alternate">
            </a-sphere>

            <a-sphere radius="0.06" color="#FFAAFF"
              material="emissive:#FFAAFF; emissiveIntensity:1.6; opacity:0.8;"
              position="0.5 -0.6 -0.3"
              animation="property: position; to:-0.5 -1.2 -0.3; loop:true; dur: 2200; dir:alternate">
            </a-sphere>
          </a-entity>

          <a-text
            value="The jellyfish tears open reality."
            align="center"
            width="10"
            position="0 -1.4 1"
            color="#FFFFFF"
          ></a-text>

        </a-entity>


      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>

    <!-- EVOLUTION LOGIC -->
    <script>
      let state = 0;
      let markerSeen = false;
      let lastTransitionTime = 0;
      const MIN_INTERVAL = 400; // ms between transitions, avoids double-taps

      const obj1 = document.querySelector("#obj1");
      const obj2 = document.querySelector("#obj2");
      const panel = document.querySelector("#panel");
      const marker = document.querySelector("#marker");
      const story = document.querySelector("#story");

      marker.addEventListener("markerFound", () => {
        markerSeen = true;
        console.log("MARKER FOUND");
      });

      // Use ONLY 'click' to avoid touch+click double firing
      document.body.addEventListener("click", evolve, false);

      function evolve() {
        if (!markerSeen) return;

        const now = Date.now();
        if (now - lastTransitionTime < MIN_INTERVAL) {
          return; // ignore very fast double-trigger
        }
        lastTransitionTime = now;

        if (state === 0) {
          obj1.setAttribute("visible", false);
          obj2.setAttribute("visible", true);
          state = 1;
          story.textContent = "Step 2 — The jellyfish awakens.";
        } else if (state === 1) {
          obj2.setAttribute("visible", false);
          panel.setAttribute("visible", true);
          state = 2;
          story.textContent = "Step 3 — A glowing portal forms.";
        } else if (state === 2) {
          panel.setAttribute("visible", false);
          obj1.setAttribute("visible", true);
          state = 0;
          story.textContent = "Step 1 — A glowing seed reappears.";
        }
      }
    </script>
  </body>
</html>
